<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LemonNES</title>
  <link rel="icon" type="image/jpeg" href="favicon.jpg">
  <style>
    :root { --bg:#0b0f14;
    --fg:#e8f0ff; --muted:#8aa0b6; --acc:#73d7ff; --card:#121926; }
    html,body{
      height:100%; margin:0; background:var(--bg); color:var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      overflow-x: hidden; overflow-y: hidden; touch-action: none;
    }
    body { min-height: 100vh; min-width: 100vw; }
    .wrap{display:grid; grid-template-columns: 1fr 340px; gap:16px; padding:16px; box-sizing:border-box;}
    header{grid-column: 1 / -1; display:flex; align-items:center; justify-content:space-between}
    header h1{font-size:18px; margin:0; font-weight:600}
    header .sub{color:var(--muted); font-size:12px}
    .screen{background:#000; padding:8px; border-radius:16px;
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
      display:flex; align-items:center; justify-content:center; position: relative;}
    canvas{image-rendering: pixelated; image-rendering: crisp-edges; border-radius:12px; background:#000; touch-action:none;}
    .side{background:var(--card); border:1px solid rgba(255,255,255,.06); border-radius:16px; padding:12px;}
    .row{display:flex; align-items:center; gap:10px;}
    .row + .row{margin-top:10px}
    label{font-size:12px; color:var(--muted)}
    .stat{font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; color:#99b3cc}
    button, input[type="file"]::file-selector-button{background:#1a2433; color:var(--fg);
    border:1px solid rgba(255,255,255,.08); padding:8px 10px; border-radius:12px; cursor:pointer}
    button:disabled{opacity:.5; cursor:not-allowed}
    .kbd{display:inline-block; padding:.1rem .4rem; border-radius:6px; background:#0e1624;
    border:1px solid rgba(255,255,255,.05); font:11px ui-monospace}
    details{margin-top:10px}
    summary{cursor:pointer; color:var(--acc)}
    ul{margin:.25rem 0 .5rem 1.25rem}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:6px}
    
    /* Mobile controls overlay */
    .mobile-controls { display: none; position: fixed; left: 0; right: 0; bottom: 0; z-index: 1000; pointer-events:none; }
    .mobile-controls.active { display: flex; pointer-events: auto; flex-direction: row; justify-content: space-between; width: 100vw; padding: 0 2vw 2vw 2vw; box-sizing: border-box; user-select: none; }
    .dpad, .abpad { display: grid; grid-template-columns: repeat(3, 44px); grid-template-rows: repeat(3, 44px); gap: 4px; }
    .abpad { grid-template-columns: 44px 44px; grid-template-rows: 44px 44px; gap: 16px; align-self: flex-end; }
    .mobile-btn { background: #1a2433 !important; border: 2px solid #567 !important; border-radius: 8px !important; color: #e0e8ff !important; font-size: 18px !important; font-family: ui-monospace !important; width: 44px !important; height: 44px !important; display: flex !important; align-items: center !important; justify-content: center !important; user-select: none !important; touch-action: none !important; transition: background 0.1s !important; pointer-events: auto !important; }
    .mobile-btn.red { background: #c00 !important; border-color: #900 !important; color: #fff !important; }
    .mobile-btn.small { width: 60px !important; height: 28px !important; font-size: 12px !important; border-radius: 6px !important; }
    .mobile-btn:active, .mobile-btn.pressed { background: #73d7ff !important; color: #000 !important; }

    /* --- SETTINGS UI STYLES --- */
    .settings-dock { display: flex; justify-content: center; align-items: flex-start; flex: 0 0 auto; padding-top: 16px; pointer-events: auto; z-index: 1001; }
    #btnSettings { width: 44px !important; height: 44px !important; font-size: 24px !important; border-radius: 50% !important; background: #1a2433; color: #8aa0b6; border: 1px solid rgba(255,255,255,0.2) !important; }
    #btnSettings.active { background: #73d7ff !important; color: #000 !important; border-color: #73d7ff !important; }

    .settings-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .settings-modal.active { display: flex; }
    .settings-container { display: flex; background: var(--card); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; width: 90%; max-width: 700px; height: 80vh; max-height: 500px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    
    .settings-sidebar { width: 180px; background: rgba(0,0,0,0.2); border-right: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; }
    .settings-header { background: rgba(255,255,255,0.03); padding: 14px 16px; font-size: 14px; font-weight: 600; border-bottom: 1px solid rgba(255,255,255,0.05); color: var(--acc); }
    .settings-nav { flex: 1; padding: 8px 0; overflow-y: auto; }
    .settings-nav-item { padding: 10px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--muted); font-size: 13px; transition: all 0.1s; }
    .settings-nav-item:hover { background: rgba(255,255,255,0.05); color: var(--fg); }
    .settings-nav-item.active { background: rgba(115, 215, 255, 0.15); color: var(--acc); border-left: 3px solid var(--acc); }
    .settings-icon { width: 20px; text-align: center; font-size: 14px; }
    
    .settings-content { flex: 1; display: flex; flex-direction: column; }
    .settings-content-header { background: rgba(255,255,255,0.03); padding: 14px 16px; font-size: 14px; font-weight: 600; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; color: var(--acc); }
    .settings-close { cursor: pointer; color: var(--muted); font-size: 20px; padding: 0 4px; }
    .settings-close:hover { color: var(--fg); }
    .settings-body { flex: 1; padding: 20px; overflow-y: auto; }
    .settings-page { display: none; }
    .settings-page.active { display: block; }
    
    .setting-group { margin-bottom: 24px; }
    .setting-group-title { font-size: 13px; font-weight: 600; color: var(--acc); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
    .setting-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .setting-row:last-child { border-bottom: none; }
    .setting-label { font-size: 14px; color: var(--fg); }
    .setting-description { font-size: 12px; color: var(--muted); margin-top: 4px; }
    
    .toggle-switch { position: relative; width: 44px; height: 24px; background: rgba(255,255,255,0.1); border-radius: 12px; cursor: pointer; transition: background 0.2s; }
    .toggle-switch.active { background: var(--acc); }
    .toggle-knob { position: absolute; top: 3px; left: 3px; width: 18px; height: 18px; background: white; border-radius: 50%; transition: transform 0.2s; }
    .toggle-switch.active .toggle-knob { transform: translateX(20px); }
    
    input[type="range"] { width: 120px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; outline: none; -webkit-appearance: none; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: var(--acc); border-radius: 50%; cursor: pointer; }
    
    input[type="text"], input[type="url"] { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--fg); padding: 8px 12px; border-radius: 8px; font-size: 13px; width: 100%; box-sizing: border-box; }
    input[type="text"]:focus, input[type="url"]:focus { outline: none; border-color: var(--acc); }
    
    .btn-primary { background: var(--acc); color: #000; border: none; padding: 10px 20px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
    .btn-primary:hover { opacity: 0.9; }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary { background: rgba(255,255,255,0.1); color: var(--fg); border: 1px solid rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 8px; font-size: 13px; cursor: pointer; transition: background 0.2s; }
    .btn-secondary:hover { background: rgba(255,255,255,0.15); }
    
    .error-message { color: #ff6b6b; font-size: 12px; margin-top: 8px; }
    .success-message { color: #51cf66; font-size: 12px; margin-top: 8px; }
    .button-group { display: flex; gap: 8px; margin-top: 12px; }
    .speed-display { font-size: 13px; color: var(--muted); min-width: 40px; text-align: right; }
    
    /* Cheat UI Specifics */
    .cheat-input-row { display: grid; grid-template-columns: 1fr 1fr auto; gap: 8px; margin-top: 8px; }
    .cheat-list { margin-top: 16px; background: rgba(0,0,0,0.2); border-radius: 8px; max-height: 200px; overflow-y: auto; }
    .cheat-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); font-family: ui-monospace, monospace; font-size: 12px; }
    .cheat-item:last-child { border-bottom: none; }
    .cheat-btn-del { color: #ff6b6b; cursor: pointer; padding: 4px; font-weight: bold; }

    .scanlines { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; background: repeating-linear-gradient(0deg, rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0.15) 1px, transparent 1px, transparent 2px); border-radius: 12px; display: none; }
    .scanlines.active { display: block; }

    @media (max-width: 900px) {
      .wrap { display: block; padding: 2vw; }
      .side { margin-top: 20px; }
      .screen { justify-content: center; }
      canvas { width: 98vw !important; height: auto !important; max-width: 100vw; max-height: 70vw; }
      .mobile-controls { display: flex !important; }
      .settings-container { flex-direction: column; width: 95%; height: 85vh; }
      .settings-sidebar { width: 100%; flex-direction: row; overflow-x: auto; border-right: none; border-bottom: 1px solid rgba(255,255,255,0.05); }
      .settings-nav { display: flex; flex-direction: row; }
      .settings-nav-item { white-space: nowrap; }
      .settings-nav-item.active { border-left: none; border-bottom: 3px solid var(--acc); }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>LemonNES <span class="sub">- Enhanced</span></h1>
        <div class="sub">Audio, Cheats, Save States, Mobile Support</div>
      </div>
      <div class="stat" id="build"></div>
    </header>

    <div class="screen">
      <canvas id="screen" width="256" height="240" style="width:768px;height:720px"></canvas>
      <div class="scanlines" id="scanlines"></div>
    </div>

    <aside class="side">
      <div class="row">
        <input id="rom" type="file" accept=".nes,application/octet-stream" />
        <button id="btnRun" disabled>Run</button>
        <button id="btnPause" disabled>Pause</button>
        <button id="btnReset" disabled>Reset</button>
      </div>
      <div class="row stat">
        <div>ROM: <span id="romName">â€”</span></div>
      </div>
      <div class="grid2 stat">
        <div>FPS: <span id="fps">0</span></div>
        <div>CPU: <span id="mhz">â€”</span></div>
        <div>Mapper: <span id="mapper">â€”</span></div>
        <div>Mirroring: <span id="mirror">â€”</span></div>
        <div>IRQs: <span id="irqs">â€”</span></div>
      </div>

      <details>
        <summary>Controls</summary>
        <ul>
          <li>P1: <span class="kbd">Arrow Keys</span>, <span class="kbd">Z</span>=A, <span class="kbd">X</span>=B, <span class="kbd">Enter</span>=Start, <span class="kbd">Right Shift</span>=Select</li>
          <li>Touch: Mobile controls visible on touch devices</li>
        </ul>
      </details>
    </aside>
  </div>

  <div class="mobile-controls" id="mobileControls" aria-hidden="true">
    <div style="flex:1;">
      <div class="dpad">
        <div></div><button class="mobile-btn" data-key="ArrowUp" aria-label="Up">&#8593;</button><div></div>
        <button class="mobile-btn" data-key="ArrowLeft" aria-label="Left">&#8592;</button><div></div><button class="mobile-btn" data-key="ArrowRight" aria-label="Right">&#8594;</button>
        <div></div><button class="mobile-btn" data-key="ArrowDown" aria-label="Down">&#8595;</button><div></div>
      </div>
    </div>
    <div class="settings-dock">
      <button id="btnSettings" class="mobile-btn" aria-label="Settings">âš™</button>
    </div>
    <div style="flex:1;display:flex;flex-direction:column;align-items:flex-end;justify-content:flex-end;gap:8px;">
      <div class="abpad">
        <button class="mobile-btn" data-key="KeyZ" aria-label="A">A</button>
        <button class="mobile-btn" data-key="KeyX" aria-label="B">B</button>
        <button class="mobile-btn small" data-key="Enter" aria-label="Start">Start</button>
        <button class="mobile-btn small" data-key="ShiftRight" aria-label="Select">Sel</button>
      </div>
    </div>
  </div>

  <div id="settingsModal" class="settings-modal">
    <div class="settings-container">
      <div class="settings-sidebar">
        <div class="settings-header">Settings</div>
        <div class="settings-nav">
          <div class="settings-nav-item active" data-page="audio"><span class="settings-icon">ðŸ”Š</span><span>Audio</span></div>
          <div class="settings-nav-item" data-page="input"><span class="settings-icon">ðŸŽ®</span><span>Input</span></div>
          <div class="settings-nav-item" data-page="display"><span class="settings-icon">ðŸ–¥</span><span>Display</span></div>
          <div class="settings-nav-item" data-page="emulation"><span class="settings-icon">âš¡</span><span>Emulation</span></div>
          <div class="settings-nav-item" data-page="cheats"><span class="settings-icon">ðŸ§©</span><span>Cheats</span></div>
          <div class="settings-nav-item" data-page="rom"><span class="settings-icon">ðŸ“¦</span><span>ROM</span></div>
          <div class="settings-nav-item" data-page="savestate"><span class="settings-icon">ðŸ’¾</span><span>Save States</span></div>
        </div>
      </div>
      
      <div class="settings-content">
        <div class="settings-content-header">
          <span id="settingsTitle">Audio Settings</span>
          <span class="settings-close" onclick="closeSettings()">âœ•</span>
        </div>
        
        <div class="settings-body">
          <div class="settings-page active" id="pageAudio">
            <div class="setting-group">
              <div class="setting-group-title">Sound</div>
              <div class="setting-row">
                <div><div class="setting-label">Audio Enabled</div><div class="setting-description">Enable or disable sound output</div></div>
                <div class="toggle-switch active" id="toggleAudioEnabled"><div class="toggle-knob"></div></div>
              </div>
              <div class="setting-row">
                <div><div class="setting-label">Volume</div><div class="setting-description">Adjust audio volume level</div></div>
                <div style="display: flex; align-items: center; gap: 12px;">
                  <input type="range" id="sliderVolume" min="0" max="100" value="80" />
                  <span class="speed-display" id="volumeDisplay">80%</span>
                </div>
              </div>
            </div>
          </div>

          <div class="settings-page" id="pageInput">
            <div class="setting-group">
              <div class="setting-group-title">Input Methods</div>
              <div class="setting-row">
                <div><div class="setting-label">Keyboard Input</div><div class="setting-description">Enable keyboard controls</div></div>
                <div class="toggle-switch active" id="toggleKeyboard"><div class="toggle-knob"></div></div>
              </div>
              <div class="setting-row">
                <div><div class="setting-label">Touch Input</div><div class="setting-description">Enable on-screen touch controls</div></div>
                <div class="toggle-switch active" id="toggleTouch"><div class="toggle-knob"></div></div>
              </div>
            </div>
          </div>

          <div class="settings-page" id="pageDisplay">
            <div class="setting-group">
              <div class="setting-group-title">Visual</div>
              <div class="setting-row">
                <div><div class="setting-label">Integer Scaling</div><div class="setting-description">Scale canvas by whole numbers</div></div>
                <div class="toggle-switch active" id="toggleIntegerScale"><div class="toggle-knob"></div></div>
              </div>
              <div class="setting-row">
                <div><div class="setting-label">Scanlines</div><div class="setting-description">Add CRT scanline effect</div></div>
                <div class="toggle-switch" id="toggleScanlines"><div class="toggle-knob"></div></div>
              </div>
            </div>
          </div>

          <div class="settings-page" id="pageEmulation">
            <div class="setting-group">
              <div class="setting-group-title">Speed</div>
              <div class="setting-row">
                <div><div class="setting-label">Emulation Speed</div><div class="setting-description">Adjust game speed (1.0x = normal)</div></div>
                <div style="display: flex; align-items: center; gap: 12px;">
                  <input type="range" id="sliderSpeed" min="25" max="200" value="100" step="25" />
                  <span class="speed-display" id="speedDisplay">1.0x</span>
                </div>
              </div>
            </div>
            <div class="setting-group">
              <div class="setting-group-title">System</div>
              <div class="setting-row">
                <div><div class="setting-label">Reset Emulator</div><div class="setting-description">Reset CPU, PPU, APU (keeps ROM)</div></div>
                <button class="btn-secondary" id="btnResetEmulator">Reset</button>
              </div>
            </div>
          </div>

          <div class="settings-page" id="pageCheats">
            <div class="setting-group">
              <div class="setting-group-title">Manual Cheats</div>
              <div class="setting-row" style="flex-direction: column; align-items: stretch;">
                <div>
                  <div class="setting-label">Add Cheat</div>
                  <div class="setting-description">Intercept CPU Read (Addr: Val)</div>
                </div>
                <div class="cheat-input-row">
                  <input type="text" id="cheatAddr" placeholder="Addr (e.g. 00A5)" maxlength="4">
                  <input type="text" id="cheatVal" placeholder="Val (e.g. 03)" maxlength="2">
                  <button class="btn-primary" id="btnAddCheat">+</button>
                </div>
                <div class="cheat-list" id="cheatListContainer">
                  </div>
              </div>
            </div>
          </div>

          <div class="settings-page" id="pageROM">
            <div class="setting-group">
              <div class="setting-group-title">Load from URL</div>
              <div class="setting-row" style="flex-direction: column; align-items: stretch;">
                <div><div class="setting-label">ROM URL</div><div class="setting-description">Load a .nes file from a direct URL</div></div>
                <input type="url" id="inputROMUrl" placeholder="https://example.com/game.nes" style="margin-top: 12px;" />
                <div class="button-group">
                  <button class="btn-primary" id="btnFetchROM">Fetch ROM</button>
                </div>
                <div id="romUrlStatus"></div>
              </div>
            </div>
          </div>

          <div class="settings-page" id="pageSaveState">
            <div class="setting-group">
              <div class="setting-group-title">Save State Management</div>
              <div class="setting-row" style="flex-direction: column; align-items: stretch;">
                <div><div class="setting-label">Export Save State</div><div class="setting-description">Save current emulator state to file</div></div>
                <div class="button-group">
                  <button class="btn-primary" id="btnExportState" disabled>Export .sav</button>
                </div>
              </div>
              <div class="setting-row" style="flex-direction: column; align-items: stretch;">
                <div><div class="setting-label">Import Save State</div><div class="setting-description">Load previously saved state</div></div>
                <div class="button-group">
                  <input type="file" id="inputSaveState" accept=".sav" style="display: none;" />
                  <button class="btn-secondary" id="btnImportState" disabled>Import .sav</button>
                </div>
                <div id="saveStateStatus"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const BUILD = new Date().toISOString().replace('T',' ').slice(0,19);
  document.getElementById('build').textContent = `build ${BUILD}`;

  // ===== GLOBAL SETTINGS OBJECT =====
  const Settings = {
    input: { keyboard: true, touch: true, gamepad: false },
    audio: { enabled: true, volume: 0.8 },
    display: { integerScale: true, scanlines: false },
    emulation: { speed: 1 },
    cheats: [] // { addr: 0x1234, val: 0xFF }
  };

  // ===== APU Timing Constants =====
  const CPU_FREQ = 1789773;
  const AUDIO_SAMPLE_RATE = 44100;
  const CYCLES_PER_SAMPLE = CPU_FREQ / AUDIO_SAMPLE_RATE;
  const u8 = n => n & 0xFF;
  const u16 = n => n & 0xFFFF;
  const toHex=(n,len=2)=>('0'.repeat(len)+n.toString(16).toUpperCase()).slice(-len);

  // ===== Controllers =====
  class Controllers{
    constructor(){
      this.state1=0; this.state2=0; this.latch=0; this.shift1=0; this.shift2=0;
      this.keyMap = { 'KeyZ':0, 'KeyX':1, 'ShiftRight':2, 'Enter':3, 'ArrowUp':4,'ArrowDown':5,'ArrowLeft':6,'ArrowRight':7 };
      this.bindKeys();
      this.initMobile();
    }
    bindKeys(){
      window.addEventListener('keydown',e=>{
        if(e.repeat || !Settings.input.keyboard) return;
        if(this.keyMap[e.code]!==undefined){ this.state1 |= (1<<this.keyMap[e.code]); e.preventDefault(); }
      });
      window.addEventListener('keyup',e=>{
        if(!Settings.input.keyboard) return;
        if(this.keyMap[e.code]!==undefined){ this.state1 &= ~(1<<this.keyMap[e.code]); e.preventDefault(); }
      });
    }
    write(v){ this.latch = v & 1; if(this.latch){ this.shift1=this.state1; this.shift2=this.state2; }}
    read1(){ const out = this.shift1 & 1; if(!this.latch) this.shift1 = (this.shift1>>>1)|0x80; return out; }
    read2(){ const out = this.shift2 & 1; if(!this.latch) this.shift2 = (this.shift2>>>1)|0x80; return out; }
    initMobile() {
      const mobileControls = document.getElementById('mobileControls');
      if (!mobileControls) return;
      const enableMobile = () => { mobileControls.classList.add('active'); };
      const disableMobile = () => { mobileControls.classList.remove('active'); };
      if ('ontouchstart' in window || navigator.maxTouchPoints || window.innerWidth < 900) enableMobile();
      window.addEventListener('resize', ()=>{
        if(window.innerWidth < 900) enableMobile(); else if(!('ontouchstart' in window)) disableMobile();
      });
      const btns = mobileControls.querySelectorAll('.mobile-btn');
      for(const btn of btns) {
        if(btn.id === 'btnSettings') continue;
        const code = btn.dataset.key;
        const bit = this.keyMap[code];
        if(bit === undefined) continue;
        const press = e => { if(!Settings.input.touch) return; this.state1 |= (1<<bit); btn.classList.add('pressed'); e.preventDefault(); };
        const release = e => { if(!Settings.input.touch) return; this.state1 &= ~(1<<bit); btn.classList.remove('pressed'); e.preventDefault(); };
        btn.addEventListener('touchstart', press, {passive:false});
        btn.addEventListener('touchend', release, {passive:false});
        btn.addEventListener('mousedown', press); btn.addEventListener('mouseup', release); btn.addEventListener('mouseleave', release);
        btn.addEventListener('contextmenu', e=>e.preventDefault());
      }
      mobileControls.addEventListener('touchmove', e=>{ if(e.target.classList.contains('mobile-btn')) e.preventDefault(); }, {passive:false});
    }
  }

  // ===== APU =====
  class APU {
    constructor() {
      this.audioCtx = null; this.scriptNode = null; this.audioBuffer = []; this.bufferSize = 4096;
      this.cpuCycleAccumulator = 0; this.frameCounter = 0; this.frameMode = 0; this.irqInhibit = false; this.frameIRQ = false; this.frameSequencerCycle = 0;
      this.pulse1 = this.createPulseChannel(); this.pulse2 = this.createPulseChannel();
      this.triangle = this.createTriangleChannel(); this.noise = this.createNoiseChannel(); this.dmc = this.createDMCChannel();
      this.initAudio();
    }
    initAudio() {
      try {
        this.audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: AUDIO_SAMPLE_RATE });
        this.scriptNode = this.audioCtx.createScriptProcessor(this.bufferSize, 0, 1);
        this.scriptNode.onaudioprocess = (e) => {
          const output = e.outputBuffer.getChannelData(0);
          for (let i = 0; i < output.length; i++) output[i] = this.audioBuffer.shift() || 0;
          while (this.audioBuffer.length < this.bufferSize * 2) this.audioBuffer.push(0);
        };
        this.scriptNode.connect(this.audioCtx.destination);
        document.addEventListener('click', () => { if (this.audioCtx.state === 'suspended') this.audioCtx.resume(); }, { once: true });
      } catch (e) { console.warn('Audio init failed:', e); }
    }
    createPulseChannel() { return { enabled: false, lengthCounter: 0, lengthHalt: false, constantVolume: false, volume: 0, duty: 0, dutyPos: 0, timer: 0, timerPeriod: 0, timerCycle: 0, sweepEnabled: false, sweepPeriod: 0, sweepNegate: false, sweepShift: 0, sweepReload: false, sweepCounter: 0, envelopeStart: false, envelopeCounter: 0, envelopeVolume: 0, envelopePeriod: 0, output: 0 }; }
    createTriangleChannel() { return { enabled: false, lengthCounter: 0, lengthHalt: false, timer: 0, timerPeriod: 0, timerCycle: 0, linearCounter: 0, linearCounterReload: 0, linearCounterControl: false, linearReloadFlag: false, sequencePos: 0, output: 0 }; }
    createNoiseChannel() { return { enabled: false, lengthCounter: 0, lengthHalt: false, constantVolume: false, volume: 0, timer: 0, timerPeriod: 0, timerCycle: 0, mode: false, shiftRegister: 1, envelopeStart: false, envelopeCounter: 0, envelopeVolume: 0, envelopePeriod: 0, output: 0 }; }
    createDMCChannel() { return { enabled: false, irqEnabled: false, loop: false, timer: 0, timerPeriod: 0, timerCycle: 0, output: 0, sampleAddress: 0, sampleLength: 0, currentAddress: 0, bytesRemaining: 0, sampleBuffer: 0, sampleBufferEmpty: true, shiftRegister: 0, bitsRemaining: 0, silence: true }; }
    
    step(cpuCycles) {
      this.stepFrameSequencer(cpuCycles);
      for (let i = 0; i < cpuCycles; i++) {
        if (i % 2 === 0) { this.stepPulseTimer(this.pulse1); this.stepPulseTimer(this.pulse2); this.stepNoiseTimer(this.noise); }
        this.stepTriangleTimer(this.triangle); this.stepDMCTimer(this.dmc);
      }
      this.cpuCycleAccumulator += cpuCycles;
      while (this.cpuCycleAccumulator >= CYCLES_PER_SAMPLE) {
        this.cpuCycleAccumulator -= CYCLES_PER_SAMPLE;
        const sample = this.mixOutput();
        this.audioBuffer.push(sample * (Settings.audio.enabled ? 1 : 0) * Settings.audio.volume);
        if (this.audioBuffer.length > this.bufferSize * 4) this.audioBuffer = this.audioBuffer.slice(-this.bufferSize * 2);
      }
    }
    stepFrameSequencer(cpuCycles) {
      this.frameSequencerCycle += cpuCycles;
      const P = 7457.5;
      while (this.frameSequencerCycle >= P) {
        this.frameSequencerCycle -= P;
        if (this.frameMode === 0) {
          switch (this.frameCounter) {
            case 0: case 2: this.clockEnvelopes(); this.clockTriangleLinearCounter(); break;
            case 1: this.clockEnvelopes(); this.clockTriangleLinearCounter(); this.clockLengthCounters(); this.clockSweeps(); break;
            case 3: this.clockEnvelopes(); this.clockTriangleLinearCounter(); this.clockLengthCounters(); this.clockSweeps(); if (!this.irqInhibit) this.frameIRQ = true; break;
          }
          this.frameCounter = (this.frameCounter + 1) % 4;
        } else {
          switch (this.frameCounter) {
            case 0: case 2: this.clockEnvelopes(); this.clockTriangleLinearCounter(); break;
            case 1: case 3: this.clockEnvelopes(); this.clockTriangleLinearCounter(); this.clockLengthCounters(); this.clockSweeps(); break;
          }
          this.frameCounter = (this.frameCounter + 1) % 5;
        }
      }
    }
    stepPulseTimer(p) { p.timerCycle++; if (p.timerCycle >= p.timerPeriod + 1) { p.timerCycle = 0; p.dutyPos = (p.dutyPos + 1) % 8; } this.updatePulseOutput(p); }
    stepTriangleTimer(t) { if (t.lengthCounter > 0 && t.linearCounter > 0) { t.timerCycle++; if (t.timerCycle >= t.timerPeriod + 1) { t.timerCycle = 0; t.sequencePos = (t.sequencePos + 1) % 32; } } this.updateTriangleOutput(t); }
    stepNoiseTimer(n) { n.timerCycle++; if (n.timerCycle >= n.timerPeriod + 1) { n.timerCycle = 0; const f = n.mode ? ((n.shiftRegister >> 6) & 1) ^ (n.shiftRegister & 1) : ((n.shiftRegister >> 1) & 1) ^ (n.shiftRegister & 1); n.shiftRegister = (n.shiftRegister >> 1) | (f << 14); } this.updateNoiseOutput(n); }
    stepDMCTimer(d) { if (d.enabled && d.bytesRemaining > 0) { d.timerCycle++; if (d.timerCycle >= d.timerPeriod + 1) d.timerCycle = 0; } }
    updatePulseOutput(p) { if (!p.enabled || p.lengthCounter === 0 || p.timerPeriod < 8) { p.output = 0; return; } const duty = [[0,1,0,0,0,0,0,0], [0,1,1,0,0,0,0,0], [0,1,1,1,1,0,0,0], [1,0,0,1,1,1,1,1]][p.duty][p.dutyPos]; p.output = duty * (p.constantVolume ? p.volume : p.envelopeVolume); }
    updateTriangleOutput(t) { if (!t.enabled || t.lengthCounter === 0 || t.linearCounter === 0) { t.output = 0; return; } t.output = [15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15][t.sequencePos]; }
    updateNoiseOutput(n) { if (!n.enabled || n.lengthCounter === 0 || (n.shiftRegister & 1)) { n.output = 0; return; } n.output = (n.constantVolume ? n.volume : n.envelopeVolume); }
    clockEnvelopes() { [this.pulse1, this.pulse2, this.noise].forEach(ch => { if (ch.envelopeStart) { ch.envelopeStart = false; ch.envelopeVolume = 15; ch.envelopeCounter = ch.envelopePeriod; } else { if (ch.envelopeCounter === 0) { ch.envelopeCounter = ch.envelopePeriod; if (ch.envelopeVolume > 0) ch.envelopeVolume--; else if (ch.lengthHalt) ch.envelopeVolume = 15; } else ch.envelopeCounter--; } }); }
    clockLengthCounters() { [this.pulse1, this.pulse2, this.triangle, this.noise].forEach(ch => { if (ch.lengthCounter > 0 && !ch.lengthHalt) ch.lengthCounter--; }); }
    clockTriangleLinearCounter() { if (this.triangle.linearReloadFlag) this.triangle.linearCounter = this.triangle.linearCounterReload; else if (this.triangle.linearCounter > 0) this.triangle.linearCounter--; if (!this.triangle.linearCounterControl) this.triangle.linearReloadFlag = false; }
    clockSweeps() { [this.pulse1, this.pulse2].forEach((p, idx) => { if (p.sweepReload) { p.sweepCounter = p.sweepPeriod; p.sweepReload = false; } else if (p.sweepCounter > 0) p.sweepCounter--; else { p.sweepCounter = p.sweepPeriod; if (p.sweepEnabled && p.sweepShift > 0) { const delta = p.timerPeriod >> p.sweepShift; p.timerPeriod += p.sweepNegate ? -(delta + (idx===0?1:0)) : delta; if (p.timerPeriod < 8 || p.timerPeriod > 0x7FF) p.lengthCounter = 0; } } }); }
    mixOutput() { const p = 95.88 / ((8128.0 / (this.pulse1.output + this.pulse2.output)) + 100); const tnd = 159.79 / ((1.0 / (this.triangle.output/8227.0 + this.noise.output/12241.0 + this.dmc.output/22638.0)) + 100); return (p + tnd) * 0.5; }
    write(addr, val) {
      if(addr===0x4015){ this.pulse1.enabled=!!(val&1); this.pulse2.enabled=!!(val&2); this.triangle.enabled=!!(val&4); this.noise.enabled=!!(val&8); this.dmc.enabled=!!(val&16); if(!this.pulse1.enabled)this.pulse1.lengthCounter=0; if(!this.pulse2.enabled)this.pulse2.lengthCounter=0; if(!this.triangle.enabled)this.triangle.lengthCounter=0; if(!this.noise.enabled)this.noise.lengthCounter=0; return; }
      if(addr===0x4017){ this.frameMode=(val>>7)&1; this.irqInhibit=!!(val&0x40); if(this.irqInhibit)this.frameIRQ=false; this.frameCounter=0; this.frameSequencerCycle=0; if(this.frameMode===1){this.clockEnvelopes();this.clockTriangleLinearCounter();this.clockLengthCounters();this.clockSweeps();} return; }
      switch(addr){ 
        case 0x4000: this.pulse1.duty=(val>>6)&3; this.pulse1.lengthHalt=!!(val&0x20); this.pulse1.constantVolume=!!(val&0x10); this.pulse1.volume=val&0xF; this.pulse1.envelopePeriod=val&0xF; break;
        case 0x4001: this.pulse1.sweepEnabled=!!(val&0x80); this.pulse1.sweepPeriod=(val>>4)&7; this.pulse1.sweepNegate=!!(val&8); this.pulse1.sweepShift=val&7; this.pulse1.sweepReload=true; break;
        case 0x4002: this.pulse1.timerPeriod=(this.pulse1.timerPeriod&0x700)|val; break;
        case 0x4003: this.pulse1.timerPeriod=(this.pulse1.timerPeriod&0xFF)|((val&7)<<8); if(this.pulse1.enabled) this.pulse1.lengthCounter=this.lengthTable[val>>3]; this.pulse1.envelopeStart=true; this.pulse1.dutyPos=0; break;
        case 0x4004: this.pulse2.duty=(val>>6)&3; this.pulse2.lengthHalt=!!(val&0x20); this.pulse2.constantVolume=!!(val&0x10); this.pulse2.volume=val&0xF; this.pulse2.envelopePeriod=val&0xF; break;
        case 0x4005: this.pulse2.sweepEnabled=!!(val&0x80); this.pulse2.sweepPeriod=(val>>4)&7; this.pulse2.sweepNegate=!!(val&8); this.pulse2.sweepShift=val&7; this.pulse2.sweepReload=true; break;
        case 0x4006: this.pulse2.timerPeriod=(this.pulse2.timerPeriod&0x700)|val; break;
        case 0x4007: this.pulse2.timerPeriod=(this.pulse2.timerPeriod&0xFF)|((val&7)<<8); if(this.pulse2.enabled) this.pulse2.lengthCounter=this.lengthTable[val>>3]; this.pulse2.envelopeStart=true; this.pulse2.dutyPos=0; break;
        case 0x4008: this.triangle.linearCounterControl=!!(val&0x80); this.triangle.lengthHalt=!!(val&0x80); this.triangle.linearCounterReload=val&0x7F; break;
        case 0x400A: this.triangle.timerPeriod=(this.triangle.timerPeriod&0x700)|val; break;
        case 0x400B: this.triangle.timerPeriod=(this.triangle.timerPeriod&0xFF)|((val&7)<<8); if(this.triangle.enabled) this.triangle.lengthCounter=this.lengthTable[val>>3]; this.triangle.linearReloadFlag=true; break;
        case 0x400C: this.noise.lengthHalt=!!(val&0x20); this.noise.constantVolume=!!(val&0x10); this.noise.volume=val&0xF; this.noise.envelopePeriod=val&0xF; break;
        case 0x400E: this.noise.mode=!!(val&0x80); this.noise.timerPeriod=this.noiseTable[val&0xF]; break;
        case 0x400F: if(this.noise.enabled) this.noise.lengthCounter=this.lengthTable[val>>3]; this.noise.envelopeStart=true; break;
      }
    }
    read(addr) { if(addr===0x4015){ const s = (this.pulse1.lengthCounter>0?1:0)|(this.pulse2.lengthCounter>0?2:0)|(this.triangle.lengthCounter>0?4:0)|(this.noise.lengthCounter>0?8:0)|(this.dmc.bytesRemaining>0?16:0)|(this.frameIRQ?64:0)|(this.dmc.irqEnabled?128:0); this.frameIRQ=false; return s; } return 0; }
    lengthTable = [10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30];
    noiseTable = [4,8,16,32,64,96,128,160,202,254,380,508,762,1016,2034,4068];
  }

  // ===== Mappers =====
  class Mapper { constructor(cart) { this.cart = cart; } prgRead(addr){return 0;} prgWrite(addr,val){} chrRead(addr){return 0;} chrWrite(addr,val){} ppuCycle(){} }
  class Mapper0 extends Mapper { constructor(cart) { super(cart); this.prgMask = (cart.prg.length > 0x4000) ? 0x7FFF : 0x3FFF; }
    prgRead(addr) { return this.cart.prg[(addr - 0x8000) & this.prgMask]; }
    chrRead(addr) { return this.cart.chr[addr]; } chrWrite(addr, val) { if (!this.cart.chrROM) this.cart.chr[addr] = val; }
  }
  class Mapper1 extends Mapper{ constructor(c){ super(c); this.shift=0x10; this.ctrl=0x0C; this.prgBank=0; this.chrBank0=0; this.chrBank1=0; }
    writeReg(addr,val){ if(val&0x80){ this.shift=0x10; this.ctrl|=0x0C; return; }
      const complete = (this.shift & 1); this.shift = (this.shift>>1) | ((val&1)<<4);
      if(complete){ const reg = (addr>>13)&3; const data = this.shift & 0x1F; this.shift=0x10;
        if(reg===0){ this.ctrl=data; this.cart.mirror=['horizontal','vertical','single0','single1'][data&3]||'horizontal'; }
        else if(reg===1) this.chrBank0=data; else if(reg===2) this.chrBank1=data; else if(reg===3) this.prgBank=data & 0x0F;
      }
    }
    prgRead(addr){ const mode=(this.ctrl>>2)&3; const b16=b=>b*0x4000;
      if(mode<2){ const base=(this.prgBank&0xE)*0x4000; return this.cart.prg[base + (addr-0x8000)]; }
      else if(mode===2){ if(addr<0xC000) return this.cart.prg[addr-0x8000]; const base=b16(this.prgBank); return this.cart.prg[base+(addr-0xC000)]; }
      else { const base=b16(this.prgBank); if(addr<0xC000) return this.cart.prg[base+(addr-0x8000)]; return this.cart.prg[this.cart.prg.length-0x4000+(addr-0xC000)]; }
    }
    prgWrite(addr,val){ this.writeReg(addr,val); }
    chrRead(addr){ const mode=(this.ctrl>>4)&1; if(mode===0){ return this.cart.chr[(this.chrBank0&0x1E)*0x1000 + addr]; } else { return this.cart.chr[(addr<0x1000?this.chrBank0:this.chrBank1)*0x1000 + (addr&0xFFF)]; } }
    chrWrite(addr,val){ if(this.cart.chrRAM){ const mode=(this.ctrl>>4)&1; if(mode===0){ this.cart.chr[(this.chrBank0&0x1E)*0x1000 + addr]=val; } else { this.cart.chr[(addr<0x1000?this.chrBank0:this.chrBank1)*0x1000 + (addr&0xFFF)]=val; } } }
  }
  class Mapper2 extends Mapper{ constructor(c){ super(c); this.bank=0; }
    prgRead(addr){ if(addr<0xC000) return this.cart.prg[this.bank*0x4000 + (addr-0x8000)]; return this.cart.prg[this.cart.prg.length-0x4000 + (addr-0xC000)]; }
    prgWrite(addr,val){ this.bank = val & 0x0F; }
  }
  class Mapper3 extends Mapper{ constructor(c){ super(c); this.chrBank=0; }
    prgRead(addr){ return this.cart.prg[addr-0x8000]; } prgWrite(addr,val){ this.chrBank = val & 3; } chrRead(addr){ return this.cart.chr[this.chrBank*0x2000 + addr]; }
  }
  class Mapper4 extends Mapper {
    constructor(cart) { super(cart); this.cpu=null; this.ppu=null; this.bankSelect=0; this.bankData=new Uint8Array(8); this.prgMode=0; this.chrMode=0; this.irqLatch=0; this.irqCounter=0; this.irqEnable=false; this.irqReloadPending=false; this.prgBanks=new Uint8Array(4); this.chrBanks=new Uint8Array(8); this.prgBanksTotal=this.cart.prg.length/0x2000; this.lastBank=this.prgBanksTotal-1; this.updatePrgMapping(); this.updateChrMapping(); }
    ppuCycle() { if(!this.ppu) return; const render=(this.ppu.mask&0x18)!==0; if(!render) return; if(this.ppu.cycle===260 && this.ppu.scanline>=0 && this.ppu.scanline<=239) this.clockCounter(); }
    clockCounter() { if(this.irqReloadPending){this.irqCounter=this.irqLatch;this.irqReloadPending=false;} else if(this.irqCounter===0){this.irqCounter=this.irqLatch;} else{this.irqCounter--;} if(this.irqCounter===0 && this.irqEnable && this.cpu) this.cpu.irqLine=true; }
    prgRead(addr) { if(addr>=0x6000 && addr<=0x7FFF) return this.cart.sram[addr-0x6000]; const b=this.prgBanks[(addr-0x8000)>>13]; return this.cart.prg[(b*0x2000)+(addr&0x1FFF)]; }
    prgWrite(addr,val) { if(addr>=0x6000 && addr<=0x7FFF){this.cart.sram[addr-0x6000]=val; return;} this.writeRegister(addr,val); }
    chrRead(addr) { const i=addr>>10, o=addr&0x3FF; const bi=this.chrMode===0?i:(i<4?i+4:i-4); let b=this.chrBanks[bi]; const tot=this.cart.chr.length>>10; if(tot>0) b%=tot; return this.cart.chr[(b*1024)+o]; }
    chrWrite(addr,val) { if(this.cart.chrROM) return; const i=addr>>10, o=addr&0x3FF; const bi=this.chrMode===0?i:(i<4?i+4:i-4); let b=this.chrBanks[bi]; const tot=this.cart.chr.length>>10; if(tot>0) b%=tot; this.cart.chr[(b*1024)+o]=val; }
    writeRegister(addr,val) {
      if(addr<0x8000) return;
      if((addr&1)===0) {
        if(addr<0xA000){ this.bankSelect=val; const p=(val>>6)&1, c=(val>>7)&1; if(this.prgMode!==p){this.prgMode=p;this.updatePrgMapping();} if(this.chrMode!==c){this.chrMode=c;this.updateChrMapping();} }
        else if(addr<0xC000){ if(this.ppu) this.ppu.mirror=(val&1)?'horizontal':'vertical'; }
        else if(addr<0xE000){ this.irqLatch=val; } else { this.irqEnable=false; if(this.cpu) this.cpu.irqLine=false; }
      } else {
        if(addr<0xA000){ this.bankData[this.bankSelect&7]=val; (this.bankSelect&7)>=6?this.updatePrgMapping():this.updateChrMapping(); }
        else if(addr<0xC000){} else if(addr<0xE000){ this.irqCounter=0; this.irqReloadPending=true; } else { this.irqEnable=true; }
      }
    }
    updatePrgMapping() { this.prgBanks[0]=this.prgMode===0?this.bankData[6]:this.lastBank-1; this.prgBanks[1]=this.bankData[7]; this.prgBanks[2]=this.prgMode===0?this.lastBank-1:this.bankData[6]; this.prgBanks[3]=this.lastBank; }
    updateChrMapping() { const R=this.bankData; this.chrBanks[0]=R[0]&0xFE; this.chrBanks[1]=R[0]|1; this.chrBanks[2]=R[1]&0xFE; this.chrBanks[3]=R[1]|1; this.chrBanks[4]=R[2]; this.chrBanks[5]=R[3]; this.chrBanks[6]=R[4]; this.chrBanks[7]=R[5]; }
  }

  // ===== Cartridge =====
  class Cartridge {
    constructor(bytes) {
      if (bytes[0]!==0x4E||bytes[1]!==0x45||bytes[2]!==0x53||bytes[3]!==0x1A) throw new Error('Invalid iNES ROM file');
      const prgBanks=bytes[4], chrBanks=bytes[5], f6=bytes[6], f7=bytes[7];
      this.mapper=(f7&0xF0)|(f6>>4); this.mirror=(f6&1)?'vertical':'horizontal'; if(f6&8)this.mirror='four';
      const hasTrainer=!!(f6&4); let offset=16+(hasTrainer?512:0);
      this.prg=bytes.slice(offset,offset+prgBanks*16384); offset+=prgBanks*16384;
      this.chrROM=chrBanks>0; this.chr=this.chrROM?bytes.slice(offset,offset+chrBanks*8192):new Uint8Array(8192); this.chrRAM=!this.chrROM;
      this.sram=new Uint8Array(0x2000);
    }
  }

  // ===== Bus =====
  class Bus {
    constructor(cpu, ppu, cart, input, apu){ this.cpu=cpu; this.ppu=ppu; this.cart=cart; this.input=input; this.apu=apu; this.ram=new Uint8Array(0x800); }
    cpuRead(addr){ 
      addr&=0xFFFF;
      // === CHEAT HOOK ===
      if(Settings.cheats.length > 0) {
        for(const c of Settings.cheats) { if(c.addr === addr) return c.val; }
      }
      // ==================
      if(addr<0x2000) return this.ram[addr&0x7FF];
      if(addr<0x4000) return this.ppu.read(0x2000+(addr&7));
      if(addr===0x4015) return this.apu.read(addr);
      if(addr===0x4016) return this.input.read1();
      if(addr===0x4017) return this.input.read2();
      if(addr>=0x8000) return this.ppu.mapper.prgRead(addr); 
      if(addr>=0x6000) return this.ppu.cart.sram[addr-0x6000];
      return 0;
    }
    cpuWrite(addr,val){ 
      addr&=0xFFFF; val&=0xFF; 
      if(addr<0x2000){this.ram[addr&0x7FF]=val; return;}
      if(addr<0x4000){this.ppu.write(0x2000+(addr&7), val); return;}
      if(addr===0x4014){ const page=val<<8; const buf=new Uint8Array(256); for(let i=0;i<256;i++) buf[i]=this.cpuRead(page+i); this.ppu.doDMA(buf); this.cpu.stall+=513+(this.cpu.cycles%2===1?1:0); return;}
      if(addr===0x4016){this.input.write(val); return;}
      if(addr>=0x4000 && addr<=0x4017){ this.apu.write(addr,val); return; }
      if(addr>=0x8000){this.ppu.mapper.prgWrite(addr,val); return;}
      if(addr>=0x6000){this.ppu.cart.sram[addr-0x6000]=val; return;}
    }
  }

  // ===== PPU =====
  class PPU {
    constructor() {
      this.v=0;this.t=0;this.x=0;this.w=0;this.ctrl=0;this.mask=0;this.status=0;this.oamaddr=0;this.buffered=0;this.openBus=0;
      this.oam=new Uint8Array(256); this.secOAM=new Uint8Array(32); this.spriteCount=0; this.spriteZeroInLine=false;
      this.cycle=0;this.scanline=261;this.frame=0;this.nmi=false;this.frameComplete=false;
      this.vram=new Uint8Array(0x800); this.palette=new Uint8Array(32); this.bgLatch={lo:0,hi:0,pal:0}; this.oddFrame=false;
      this.bgShiftLo=0; this.bgShiftHi=0; this.bgAttrShiftLo=0; this.bgAttrShiftHi=0;
    }
    attachCanvas(c) { this.canvas=c; this.ctx=c.getContext("2d",{alpha:false,willReadFrequently:true}); this.output=this.ctx.createImageData(256,240); }
    connectCart(c) { this.cart=c; this.mapper=[Mapper0,Mapper1,Mapper2,Mapper3,Mapper4][c.mapper]?new [Mapper0,Mapper1,Mapper2,Mapper3,Mapper4][c.mapper](c):new Mapper0(c); if(this.mapper instanceof Mapper4) this.mapper.ppu=this; this.mirror=c.mirror; }
    reset() { this.v=this.t=this.x=this.w=0; this.ctrl=this.mask=this.status=this.oamaddr=0; this.cycle=0; this.scanline=261; this.nmi=false; this.bgShiftLo=this.bgShiftHi=0; }
    read(addr) { 
      switch(addr){
        case 0x2002: { const res=(this.status&0xE0)|(this.buffered&0x1F); this.openBus=res; this.status&=~0x80; this.w=0; this.nmi=false; return res; }
        case 0x2004: return this.oam[this.oamaddr];
        case 0x2007: { let v=this.ppuRead(this.v); if(this.v<0x3F00){ const t=this.buffered; this.buffered=v; v=t; } else this.buffered=this.ppuRead(this.v-0x1000); this.v+=(this.ctrl&4)?32:1; this.v&=0x7FFF; this.openBus=v; return v; }
        default: return this.openBus;
      }
    }
    write(addr,val) {
      this.openBus=val;
      switch(addr){
        case 0x2000: { const old=this.ctrl; this.ctrl=val; this.t=(this.t&0xF3FF)|((val&3)<<10); if(!(old&0x80) && (val&0x80) && (this.status&0x80)) this.nmi=true; break; }
        case 0x2001: this.mask=val; break;
        case 0x2003: this.oamaddr=val; break;
        case 0x2004: this.oam[this.oamaddr++]=val; break;
        case 0x2005: if(this.w===0){this.x=val&7;this.t=(this.t&0x7FE0)|((val&0xF8)>>3);this.w=1;}else{this.t=(this.t&0xC1F)|((val&7)<<12)|((val&0xF8)<<2);this.w=0;} break;
        case 0x2006: if(this.w===0){this.t=(this.t&0xFF)|((val&0x3F)<<8);this.w=1;}else{this.t=(this.t&0x7F00)|val;this.v=this.t;this.w=0;} break;
        case 0x2007: this.ppuWrite(this.v,val); this.v+=(this.ctrl&4)?32:1; this.v&=0x7FFF; break;
      }
    }
    doDMA(buf) { for(let i=0;i<256;i++) this.oam[(this.oamaddr+i)&0xFF]=buf[i]; }
    ntIndex(addr) { const a=(addr-0x2000)&0xFFF, nt=(a>>10)&3, off=a&0x3FF, m=this.mapper.mirroring||this.mirror; if(m==="vertical") return ((nt&1)*0x400)+off; if(m==="horizontal") return (((nt>>1)&1)*0x400)+off; if(m==="four") return a; return off; }
    ppuRead(addr) { addr&=0x3FFF; if(addr<0x2000) return this.mapper.chrRead(addr); if(addr<0x3F00) return this.vram[this.ntIndex(addr)]; let p=addr&0x1F; if((p&3)===0) p&=0xF; return this.palette[p]; }
    ppuWrite(addr,val) { addr&=0x3FFF; val&=0xFF; if(addr<0x2000){this.mapper.chrWrite(addr,val);return;} if(addr<0x3F00){this.vram[this.ntIndex(addr)]=val;return;} let p=addr&0x1F; if((p&3)===0) p&=0xF; this.palette[p]=val; }
    incX(){ if((this.v&0x1F)===31){this.v&=~0x1F;this.v^=0x400;}else{this.v++;} }
    incY(){ if((this.v&0x7000)!==0x7000){this.v+=0x1000;}else{this.v&=~0x7000;let y=(this.v&0x3E0)>>5;if(y===29){y=0;this.v^=0x800;}else if(y===31){y=0;}else{y++;}this.v=(this.v&~0x3E0)|(y<<5);} }
    copyX(){ this.v=(this.v&~0x41F)|(this.t&0x41F); } copyY(){ this.v=(this.v&~0x7BE0)|(this.t&0x7BE0); }
    bgFetch(){ const nt=0x2000|(this.v&0xFFF), at=0x23C0|(this.v&0xC00)|((this.v>>4)&0x38)|((this.v>>2)&7), fy=(this.v>>12)&7; const t=this.ppuRead(nt), a=this.ppuRead(at); const shift=((this.v>>5)&2)*2|((this.v&0x1F)&2); const pal=(a>>shift)&3; const b=(this.ctrl&0x10)?0x1000:0; const l=this.ppuRead(b+t*16+fy), h=this.ppuRead(b+t*16+fy+8); return {lo:l,hi:h,pal:pal}; }
    reload(){ this.bgShiftLo=(this.bgShiftLo&0xFF00)|this.bgLatch.lo; this.bgShiftHi=(this.bgShiftHi&0xFF00)|this.bgLatch.hi; this.bgAttrShiftLo=(this.bgAttrShiftLo&0xFF00)|(this.bgLatch.pal&1?0xFF:0); this.bgAttrShiftHi=(this.bgAttrShiftHi&0xFF00)|(this.bgLatch.pal&2?0xFF:0); }
    evalSprites(){ 
      const y=this.scanline; this.spriteCount=0; this.spriteZeroInLine=false; 
      for(let i=0;i<64;i++){ 
        const sy=this.oam[i*4]; if(y-sy>=0 && y-sy<((this.ctrl&0x20)?16:8)){
          if(this.spriteCount<8){ if(i===0) this.spriteZeroInLine=true; for(let j=0;j<4;j++) this.secOAM[this.spriteCount*4+j]=this.oam[i*4+j]; this.spriteCount++; }
          else { this.status|=0x20; break; }
        }
      }
    }
    renderPixel(x,y){
      const idx=(y*256+x)*4, img=this.output.data;
      let bgPx=0, bgPal=0; 
      if(this.mask&8){ const mux=15-this.x; bgPx=((this.bgShiftHi>>mux)&1)<<1|((this.bgShiftLo>>mux)&1); bgPal=((this.bgAttrShiftHi>>mux)&1)<<1|((this.bgAttrShiftLo>>mux)&1); }
      let spPx=0, spPal=0, spPrio=0, sp0=false;
      if(this.mask&16){
        for(let i=0;i<this.spriteCount;i++){
          const sx=this.secOAM[i*4+3]; if(x<sx || x>=sx+8) continue;
          const sy=this.secOAM[i*4], tile=this.secOAM[i*4+1], attr=this.secOAM[i*4+2], h=(this.ctrl&0x20)?16:8, row=y-sy;
          if(i===0 && this.spriteZeroInLine) sp0=true;
          const fh=(attr>>6)&1, fv=(attr>>7)&1; let fy=fv?(h-1-row):row, t=tile;
          if(h===16){ t&=0xFE; if(fy>=8){t++;fy-=8;} if(tile&1) t+=0x1000/16; } else if(this.ctrl&8) t+=0x1000/16;
          const lo=this.ppuRead(t*16+fy), hi=this.ppuRead(t*16+fy+8), bit=fh?(x-sx):(7-(x-sx));
          spPx=((hi>>bit)&1)<<1|((lo>>bit)&1); if(spPx){ spPal=attr&3; spPrio=(attr>>5)&1; break; }
        }
      }
      if(sp0 && spPx && bgPx && x<255 && x>=8 && (this.mask&8) && (this.mask&16)) this.status|=0x40;
      let pid=0;
      if(!bgPx && !spPx) pid=0; else if(bgPx && !spPx) pid=(bgPal<<2)|bgPx; else if(!bgPx && spPx) pid=0x10|(spPal<<2)|spPx; else pid=spPrio?((bgPal<<2)|bgPx):(0x10|(spPal<<2)|spPx);
      if(x<8){ if(!(this.mask&2)) bgPx=0; if(!(this.mask&4)) spPx=0; if(!bgPx && !spPx) pid=0; }
      const c=this.ppuRead(0x3F00+(pid&0x1F)), rgb=NTSC_PALETTE[c&0x3F];
      img[idx]=rgb[0]; img[idx+1]=rgb[1]; img[idx+2]=rgb[2]; img[idx+3]=255;
    }
    step() {
      if(this.mapper&&this.mapper.ppuCycle) this.mapper.ppuCycle();
      const ren=(this.mask&0x18)!==0;
      if(this.scanline===261 && this.cycle===339 && ren && this.oddFrame){ this.cycle=0; this.scanline=0; this.frame++; this.oddFrame=false; return; }
      if(this.scanline===261){
        if(this.cycle===1){this.status&=~0xE0;this.nmi=false;}
        if(this.cycle>=280 && this.cycle<=304 && ren) this.copyY();
      }
      if(this.scanline<240){
        if(this.cycle===1 && ren) this.evalSprites();
        if(this.cycle>=1 && this.cycle<=256){
          if(ren){ this.bgShiftLo<<=1; this.bgShiftHi<<=1; this.bgAttrShiftLo<<=1; this.bgAttrShiftHi<<=1; }
          const cp=(this.cycle-1)&7;
          if(cp===0 && ren) this.reload(); if(cp===1 && ren) this.bgLatch=this.bgFetch();
          this.renderPixel(this.cycle-1, this.scanline);
          if(cp===7 && ren) this.incX();
        }
        if(this.cycle===256 && ren) this.incY();
        if(this.cycle===257 && ren) this.copyX();
      }
      if(this.scanline<240 || this.scanline===261){
         if(this.cycle>=321 && this.cycle<=336 && ren){
           this.bgShiftLo<<=1; this.bgShiftHi<<=1; this.bgAttrShiftLo<<=1; this.bgAttrShiftHi<<=1;
           const cp=(this.cycle-1)&7; if(cp===0 && this.cycle>321) this.reload(); if(cp===1) this.bgLatch=this.bgFetch(); if(cp===7) this.incX();
         }
      }
      if(this.scanline===241 && this.cycle===1){ this.status|=0x80; if(this.ctrl&0x80) this.nmi=true; this.ctx.putImageData(this.output,0,0); this.frameComplete=true; }
      this.cycle++; if(this.cycle>340){ this.cycle=0; this.scanline++; if(this.scanline>261){ this.scanline=0; this.frame++; this.oddFrame=!this.oddFrame; } }
    }
  }
  const NTSC_PALETTE = [[124,124,124],[0,0,252],[0,0,188],[68,40,188],[148,0,132],[168,0,32],[168,16,0],[136,20,0],[80,48,0],[0,120,0],[0,104,0],[0,88,0],[0,64,88],[0,0,0],[0,0,0],[0,0,0],[188,188,188],[0,120,248],[0,88,248],[104,68,252],[216,0,204],[228,0,88],[248,56,0],[228,92,16],[172,124,0],[0,184,0],[0,168,0],[0,168,68],[0,136,136],[0,0,0],[0,0,0],[0,0,0],[248,248,248],[60,188,252],[104,136,252],[152,120,248],[248,120,248],[248,88,152],[248,120,88],[252,160,68],[248,184,0],[184,248,24],[88,216,84],[88,248,152],[0,232,216],[120,120,120],[0,0,0],[0,0,0],[252,252,252],[164,228,252],[184,184,248],[216,184,248],[248,184,248],[248,164,192],[240,208,176],[252,224,168],[248,216,120],[216,248,120],[184,248,184],[184,248,216],[0,252,252],[248,216,248],[0,0,0],[0,0,0]];

  // ===== CPU =====
  class CPU6502{
    constructor(bus){ this.bus=bus; this.a=0; this.x=0; this.y=0; this.sp=0xFD; this.p=0x24; this.pc=0; this.cycles=0; this.stall=0; this.irqLine=false; }
    getC(){return this.p&1} setC(v){this.p=(this.p&~1)|(v&1)} getZ(){return(this.p>>1)&1} setZ(v){this.p=(this.p&~2)|((v?1:0)<<1)} getI(){return(this.p>>2)&1} setI(v){this.p=(this.p&~4)|((v?1:0)<<2)} getD(){return(this.p>>3)&1} setD(v){this.p=(this.p&~8)|((v?1:0)<<3)} getB(){return(this.p>>4)&1} setB(v){this.p=(this.p&~16)|((v?1:0)<<4)} getU(){return(this.p>>5)&1} setU(v){this.p=(this.p&~32)|((v?1:0)<<5)} getV(){return(this.p>>6)&1} setV(v){this.p=(this.p&~64)|((v?1:0)<<6)} getN(){return(this.p>>7)&1} setN(v){this.p=(this.p&~128)|((v?1:0)<<7)}
    read(a){return this.bus.cpuRead(a)} write(a,v){this.bus.cpuWrite(a,v)} push(v){this.write(0x100+this.sp,v);this.sp=u8(this.sp-1)} pop(){this.sp=u8(this.sp+1);return this.read(0x100+this.sp)}
    reset(){ this.a=0;this.x=0;this.y=0;this.sp=0xFD;this.p=0x24;this.pc=this.read(0xFFFC)|(this.read(0xFFFD)<<8);this.cycles=7;this.stall=0; }
    nmi(){ this.push((this.pc>>8)&0xFF);this.push(this.pc&0xFF);this.setB(0);this.setU(1);this.setI(1);this.push(this.p);this.pc=this.read(0xFFFA)|(this.read(0xFFFB)<<8);this.cycles+=7; }
    irq(){ if(this.getI())return; this.push((this.pc>>8)&0xFF);this.push(this.pc&0xFF);this.setB(0);this.setU(1);this.setI(1);this.push(this.p);this.pc=this.read(0xFFFE)|(this.read(0xFFFF)<<8);this.cycles+=7; }
    step(){ if(this.stall>0){this.stall--;this.cycles++;return 1;} if(this.irqLine){this.irq();this.irqLine=false;} const op=this.read(this.pc++); const e=OPCODES[op]; if(!e)return 2; this.addrMode=e.mode; this.pageCross=0; const addr=this.fetchAddr(e.mode); const cb=this.cycles; this.execute(e.ins,addr); this.cycles+=e.cyc+this.pageCross; return this.cycles-cb; }
    fetchAddr(m){
      const zp=()=>this.read(this.pc++), imm=()=>this.pc++, abs=()=>{const l=this.read(this.pc++),h=this.read(this.pc++);return l|(h<<8)};
      switch(m){ case'IMP':return null; case'IMM':return imm(); case'ZP0':return zp(); case'ZPX':return u8(zp()+this.x); case'ZPY':return u8(zp()+this.y); case'ABS':return abs(); case'ABX':{const a=abs(),r=u16(a+this.x);if((a^r)&0xFF00)this.pageCross=1;return r;} case'ABY':{const a=abs(),r=u16(a+this.y);if((a^r)&0xFF00)this.pageCross=1;return r;} case'IZX':{const t=u8(this.read(this.pc++)+this.x);return this.read(t)|(this.read(u8(t+1))<<8);} case'IZY':{const t=this.read(this.pc++),a=this.read(t)|(this.read(u8(t+1))<<8),r=u16(a+this.y);if((a^r)&0xFF00)this.pageCross=1;return r;} case'IND':{const p=abs();return this.read(p)|(this.read((p&0xFF00)|((p+1)&0xFF))<<8);} case'REL':{const o=u8(this.read(this.pc++));return o<0x80?this.pc+o:this.pc+o-0x100;} }
    }
    setZN(v){ this.setZ((v&0xFF)===0); this.setN(v&0x80); }
    execute(ins,addr){
      const rd=a=>this.read(a), wr=(a,v)=>this.write(a,u8(v));
      switch(ins){
        case'BRK':this.pc++;this.push((this.pc>>8)&0xFF);this.push(this.pc&0xFF);this.setB(1);this.push(this.p);this.setI(1);this.pc=this.read(0xFFFE)|(this.read(0xFFFF)<<8);break; case'NOP':break;
        case'LDA':this.a=rd(addr);this.setZN(this.a);break; case'LDX':this.x=rd(addr);this.setZN(this.x);break; case'LDY':this.y=rd(addr);this.setZN(this.y);break;
        case'STA':wr(addr,this.a);break; case'STX':wr(addr,this.x);break; case'STY':wr(addr,this.y);break;
        case'TAX':this.x=this.a;this.setZN(this.x);break; case'TAY':this.y=this.a;this.setZN(this.y);break; case'TXA':this.a=this.x;this.setZN(this.a);break; case'TYA':this.a=this.y;this.setZN(this.a);break;
        case'TSX':this.x=this.sp;this.setZN(this.x);break; case'TXS':this.sp=this.x;break;
        case'PHA':this.push(this.a);break; case'PHP':this.push(this.p|0x10);break; case'PLA':this.a=this.pop();this.setZN(this.a);break; case'PLP':this.p=(this.pop()&0xEF)|0x20;break;
        case'AND':this.a&=rd(addr);this.setZN(this.a);break; case'ORA':this.a|=rd(addr);this.setZN(this.a);break; case'EOR':this.a^=rd(addr);this.setZN(this.a);break;
        case'ADC':{const v=rd(addr),t=this.a+v+this.getC();this.setC(t>255);this.setV(~(this.a^v)&(this.a^t)&0x80);this.a=u8(t);this.setZN(this.a);}break;
        case'SBC':{const v=rd(addr)^255,t=this.a+v+this.getC();this.setC(t>255);this.setV(~(this.a^v)&(this.a^t)&0x80);this.a=u8(t);this.setZN(this.a);}break;
        case'CMP':{const r=this.a,v=rd(addr),t=r-v;this.setC(r>=v);this.setZN(u8(t));}break;
        case'CPX':{const r=this.x,v=rd(addr),t=r-v;this.setC(r>=v);this.setZN(u8(t));}break;
        case'CPY':{const r=this.y,v=rd(addr),t=r-v;this.setC(r>=v);this.setZN(u8(t));}break;
        case'INC':{const v=u8(rd(addr)+1);wr(addr,v);this.setZN(v);}break; case'DEC':{const v=u8(rd(addr)-1);wr(addr,v);this.setZN(v);}break;
        case'INX':this.x=u8(this.x+1);this.setZN(this.x);break; case'INY':this.y=u8(this.y+1);this.setZN(this.y);break;
        case'DEX':this.x=u8(this.x-1);this.setZN(this.x);break; case'DEY':this.y=u8(this.y-1);this.setZN(this.y);break;
        case'ASL':if(this.addrMode==='IMP'){this.setC(this.a>>7);this.a=u8(this.a<<1);this.setZN(this.a);}else{const v=rd(addr);this.setC(v>>7);const r=u8(v<<1);wr(addr,r);this.setZN(r);}break;
        case'LSR':if(this.addrMode==='IMP'){this.setC(this.a&1);this.a=u8(this.a>>>1);this.setZN(this.a);}else{const v=rd(addr);this.setC(v&1);const r=u8(v>>>1);wr(addr,r);this.setZN(r);}break;
        case'ROL':if(this.addrMode==='IMP'){const c=this.getC();this.setC(this.a>>7);this.a=u8((this.a<<1)|c);this.setZN(this.a);}else{const v=rd(addr),c=this.getC();this.setC(v>>7);const r=u8((v<<1)|c);wr(addr,r);this.setZN(r);}break;
        case'ROR':if(this.addrMode==='IMP'){const c=this.getC();this.setC(this.a&1);this.a=u8((this.a>>>1)|(c<<7));this.setZN(this.a);}else{const v=rd(addr),c=this.getC();this.setC(v&1);const r=u8((v>>>1)|(c<<7));wr(addr,r);this.setZN(r);}break;
        case'BIT':{const v=rd(addr);this.setZ((this.a&v)===0);this.setV(v&0x40);this.setN(v&0x80);}break;
        case'JMP':this.pc=addr;break; case'JSR':{const t=u16(this.pc-1);this.push((t>>8)&0xFF);this.push(t&0xFF);this.pc=addr;}break;
        case'RTS':{const l=this.pop(),h=this.pop();this.pc=((h<<8)|l)+1;}break; case'RTI':{this.p=(this.pop()&0xEF)|0x20;const l=this.pop(),h=this.pop();this.pc=(h<<8)|l;}break;
        case'BCC':if(!this.getC()){this.cycles++;if((this.pc&0xFF00)!=(addr&0xFF00))this.cycles++;this.pc=addr;}break;
        case'BCS':if(this.getC()){this.cycles++;if((this.pc&0xFF00)!=(addr&0xFF00))this.cycles++;this.pc=addr;}break;
        case'BEQ':if(this.getZ()){this.cycles++;if((this.pc&0xFF00)!=(addr&0xFF00))this.cycles++;this.pc=addr;}break;
        case'BNE':if(!this.getZ()){this.cycles++;if((this.pc&0xFF00)!=(addr&0xFF00))this.cycles++;this.pc=addr;}break;
        case'BMI':if(this.getN()){this.cycles++;if((this.pc&0xFF00)!=(addr&0xFF00))this.cycles++;this.pc=addr;}break;
        case'BPL':if(!this.getN()){this.cycles++;if((this.pc&0xFF00)!=(addr&0xFF00))this.cycles++;this.pc=addr;}break;
        case'BVC':if(!this.getV()){this.cycles++;if((this.pc&0xFF00)!=(addr&0xFF00))this.cycles++;this.pc=addr;}break;
        case'BVS':if(this.getV()){this.cycles++;if((this.pc&0xFF00)!=(addr&0xFF00))this.cycles++;this.pc=addr;}break;
        case'CLC':this.setC(0);break;case'SEC':this.setC(1);break;case'CLI':this.setI(0);break;case'SEI':this.setI(1);break;case'CLV':this.setV(0);break;case'CLD':this.setD(0);break;case'SED':this.setD(1);break;
      }
    }
  }
  const O=(m,i,c)=>({mode:m,ins:i,cyc:c}), OPCODES=new Array(256);
  [[0x00,'IMP','BRK',7],[0xEA,'IMP','NOP',2],[0xA9,'IMM','LDA',2],[0xA5,'ZP0','LDA',3],[0xB5,'ZPX','LDA',4],[0xAD,'ABS','LDA',4],[0xBD,'ABX','LDA',4],[0xB9,'ABY','LDA',4],[0xA1,'IZX','LDA',6],[0xB1,'IZY','LDA',5],[0xA2,'IMM','LDX',2],[0xA6,'ZP0','LDX',3],[0xB6,'ZPY','LDX',4],[0xAE,'ABS','LDX',4],[0xBE,'ABY','LDX',4],[0xA0,'IMM','LDY',2],[0xA4,'ZP0','LDY',3],[0xB4,'ZPX','LDY',4],[0xAC,'ABS','LDY',4],[0xBC,'ABX','LDY',4],[0x85,'ZP0','STA',3],[0x95,'ZPX','STA',4],[0x8D,'ABS','STA',4],[0x9D,'ABX','STA',5],[0x99,'ABY','STA',5],[0x81,'IZX','STA',6],[0x91,'IZY','STA',6],[0x86,'ZP0','STX',3],[0x96,'ZPY','STX',4],[0x8E,'ABS','STX',4],[0x84,'ZP0','STY',3],[0x94,'ZPX','STY',4],[0x8C,'ABS','STY',4],[0xAA,'IMP','TAX',2],[0xA8,'IMP','TAY',2],[0x8A,'IMP','TXA',2],[0x98,'IMP','TYA',2],[0xBA,'IMP','TSX',2],[0x9A,'IMP','TXS',2],[0x48,'IMP','PHA',3],[0x08,'IMP','PHP',3],[0x68,'IMP','PLA',4],[0x28,'IMP','PLP',4],[0x29,'IMM','AND',2],[0x25,'ZP0','AND',3],[0x35,'ZPX','AND',4],[0x2D,'ABS','AND',4],[0x3D,'ABX','AND',4],[0x39,'ABY','AND',4],[0x21,'IZX','AND',6],[0x31,'IZY','AND',5],[0x09,'IMM','ORA',2],[0x05,'ZP0','ORA',3],[0x15,'ZPX','ORA',4],[0x0D,'ABS','ORA',4],[0x1D,'ABX','ORA',4],[0x19,'ABY','ORA',4],[0x01,'IZX','ORA',6],[0x11,'IZY','ORA',5],[0x49,'IMM','EOR',2],[0x45,'ZP0','EOR',3],[0x55,'ZPX','EOR',4],[0x4D,'ABS','EOR',4],[0x5D,'ABX','EOR',4],[0x59,'ABY','EOR',4],[0x41,'IZX','EOR',6],[0x51,'IZY','EOR',5],[0x69,'IMM','ADC',2],[0x65,'ZP0','ADC',3],[0x75,'ZPX','ADC',4],[0x6D,'ABS','ADC',4],[0x7D,'ABX','ADC',4],[0x79,'ABY','ADC',4],[0x61,'IZX','ADC',6],[0x71,'IZY','ADC',5],[0xE9,'IMM','SBC',2],[0xE5,'ZP0','SBC',3],[0xF5,'ZPX','SBC',4],[0xED,'ABS','SBC',4],[0xFD,'ABX','SBC',4],[0xF9,'ABY','SBC',4],[0xE1,'IZX','SBC',6],[0xF1,'IZY','SBC',5],[0xC9,'IMM','CMP',2],[0xC5,'ZP0','CMP',3],[0xD5,'ZPX','CMP',4],[0xCD,'ABS','CMP',4],[0xDD,'ABX','CMP',4],[0xD9,'ABY','CMP',4],[0xC1,'IZX','CMP',6],[0xD1,'IZY','CMP',5],[0xE0,'IMM','CPX',2],[0xE4,'ZP0','CPX',3],[0xEC,'ABS','CPX',4],[0xC0,'IMM','CPY',2],[0xC4,'ZP0','CPY',3],[0xCC,'ABS','CPY',4],[0xE6,'ZP0','INC',5],[0xF6,'ZPX','INC',6],[0xEE,'ABS','INC',6],[0xFE,'ABX','INC',7],[0xC6,'ZP0','DEC',5],[0xD6,'ZPX','DEC',6],[0xCE,'ABS','DEC',6],[0xDE,'ABX','DEC',7],[0xE8,'IMP','INX',2],[0xC8,'IMP','INY',2],[0xCA,'IMP','DEX',2],[0x88,'IMP','DEY',2],[0x0A,'IMP','ASL',2],[0x06,'ZP0','ASL',5],[0x16,'ZPX','ASL',6],[0x0E,'ABS','ASL',6],[0x1E,'ABX','ASL',7],[0x4A,'IMP','LSR',2],[0x46,'ZP0','LSR',5],[0x56,'ZPX','LSR',6],[0x4E,'ABS','LSR',6],[0x5E,'ABX','LSR',7],[0x2A,'IMP','ROL',2],[0x26,'ZP0','ROL',5],[0x36,'ZPX','ROL',6],[0x2E,'ABS','ROL',6],[0x3E,'ABX','ROL',7],[0x6A,'IMP','ROR',2],[0x66,'ZP0','ROR',5],[0x76,'ZPX','ROR',6],[0x6E,'ABS','ROR',6],[0x7E,'ABX','ROR',7],[0x24,'ZP0','BIT',3],[0x2C,'ABS','BIT',4],[0x4C,'ABS','JMP',3],[0x6C,'IND','JMP',5],[0x20,'ABS','JSR',6],[0x60,'IMP','RTS',6],[0x40,'IMP','RTI',6],[0x90,'REL','BCC',2],[0xB0,'REL','BCS',2],[0xF0,'REL','BEQ',2],[0x30,'REL','BMI',2],[0xD0,'REL','BNE',2],[0x10,'REL','BPL',2],[0x50,'REL','BVC',2],[0x70,'REL','BVS',2],[0x18,'IMP','CLC',2],[0x38,'IMP','SEC',2],[0x58,'IMP','CLI',2],[0x78,'IMP','SEI',2],[0xB8,'IMP','CLV',2],[0xD8,'IMP','CLD',2],[0xF8,'IMP','SED',2]].forEach(([o,m,i,c])=>OPCODES[o]=O(m,i,c));

  // ===== NES Machine =====
  class NES {
    constructor(canvas) {
      this.ppu = new PPU(); this.ppu.attachCanvas(canvas);
      this.input = new Controllers(); this.apu = new APU();
      this.cart=null; this.bus=null; this.cpu=null; this.running=false;
      this.makeResponsiveCanvas();
      this._lastTimestamp=0; this._cpuCycleDebt=0; this._frameCount=0; this._lastFpsUpdate=performance.now();
    }
    makeResponsiveCanvas() {
      const c=this.ppu.canvas; const r=()=>{ if(window.innerWidth<900){c.style.width="98vw";c.style.height=Math.round(240*98/256)+"vw";}else{c.style.width="768px";c.style.height="720px";} };
      window.addEventListener('resize',r); r();
    }
    loadROM(bytes) {
      this.cart=new Cartridge(bytes); this.ppu.connectCart(this.cart);
      this.bus=new Bus(null,this.ppu,this.cart,this.input,this.apu);
      this.cpu=new CPU6502(this.bus); this.bus.cpu=this.cpu;
      if(this.ppu.mapper instanceof Mapper4){this.ppu.mapper.cpu=this.cpu;this.ppu.mapper.ppu=this.ppu;}
      this.cpu.reset();
      document.getElementById('mapper').textContent=this.cart.mapper; document.getElementById('mirror').textContent=this.cart.mirror;
    }
    reset(){ if(this.cpu){this.cpu.reset();this.ppu.reset();} }
    pause(){ this.running=false; }
    run() {
      if(this.running) return; this.running=true; this._lastTimestamp=performance.now(); this._cpuCycleDebt=0;
      const loop=(now)=>{
        if(!this.running) return; const elapsed=now-this._lastTimestamp; this._lastTimestamp=now;
        if(elapsed>100){requestAnimationFrame(loop);return;}
        const cyclesToRun=Math.floor((elapsed*(CPU_FREQ/1000)*Settings.emulation.speed)+this._cpuCycleDebt);
        this._cpuCycleDebt=(elapsed*(CPU_FREQ/1000)*Settings.emulation.speed)+this._cpuCycleDebt-cyclesToRun;
        let executed=0;
        while(executed<cyclesToRun){
          const cyc=this.cpu.step(); executed+=cyc;
          for(let i=0;i<cyc*3;i++){ this.ppu.step(); if(this.ppu.nmi){this.cpu.nmi();this.ppu.nmi=false;} }
          this.apu.step(cyc);
        }
        if(this.ppu.frameComplete){this._frameCount++;this.ppu.frameComplete=false;}
        if(now-this._lastFpsUpdate>=1000){
          document.getElementById('fps').textContent=this._frameCount;
          document.getElementById('mhz').textContent="~1.79";
          const elIrqs=document.getElementById('irqs');
          elIrqs.textContent=(this.ppu.mapper instanceof Mapper4)?`Cnt:${this.ppu.mapper.irqCounter} En:${this.ppu.mapper.irqEnable?'Y':'N'}`:'â€”';
          this._frameCount=0; this._lastFpsUpdate=now;
        }
        requestAnimationFrame(loop);
      };
      requestAnimationFrame(loop);
    }
    serializeState() {
      if(!this.cpu) throw new Error('No ROM loaded');
      return {
        version: 1,
        cpu:{A:this.cpu.a,X:this.cpu.x,Y:this.cpu.y,SP:this.cpu.sp,PC:this.cpu.pc,P:this.cpu.p,cycles:this.cpu.cycles},
        ppu:{ctrl:this.ppu.ctrl,mask:this.ppu.mask,status:this.ppu.status,oamAddr:this.ppu.oamaddr,v:this.ppu.v,t:this.ppu.t,x:this.ppu.x,w:this.ppu.w,cycle:this.ppu.cycle,scanline:this.ppu.scanline,vram:Array.from(this.ppu.vram),oam:Array.from(this.ppu.oam),palette:Array.from(this.ppu.palette)},
        apu:{frameCounter:this.apu.frameCounter,frameMode:this.apu.frameMode,pulse1:Object.assign({},this.apu.pulse1),pulse2:Object.assign({},this.apu.pulse2),triangle:Object.assign({},this.apu.triangle),noise:Object.assign({},this.apu.noise),dmc:Object.assign({},this.apu.dmc)},
        bus:{ram:Array.from(this.bus.ram)},
        mapper:this.cart.mapper===4?{type:4,bankSelect:this.cart.mapperObj?.bankSelect,bankData:Array.from(this.ppu.mapper.bankData),irqLatch:this.ppu.mapper.irqLatch,irqCounter:this.ppu.mapper.irqCounter,irqEnable:this.ppu.mapper.irqEnable}:this.cart.mapper===1?{type:1,shift:this.ppu.mapper.shift,ctrl:this.ppu.mapper.ctrl}:{}
      };
    }
    deserializeState(s) {
      if(!this.cpu) throw new Error('No ROM loaded');
      if(s.version!==1) throw new Error('Bad version');
      this.cpu.a=s.cpu.A;this.cpu.x=s.cpu.X;this.cpu.y=s.cpu.Y;this.cpu.sp=s.cpu.SP;this.cpu.pc=s.cpu.PC;this.cpu.p=s.cpu.P;this.cpu.cycles=s.cpu.cycles;
      this.ppu.ctrl=s.ppu.ctrl;this.ppu.mask=s.ppu.mask;this.ppu.status=s.ppu.status;this.ppu.oamaddr=s.ppu.oamAddr;this.ppu.v=s.ppu.v;this.ppu.t=s.ppu.t;this.ppu.x=s.ppu.x;this.ppu.w=s.ppu.w;this.ppu.cycle=s.ppu.cycle;this.ppu.scanline=s.ppu.scanline;this.ppu.vram.set(s.ppu.vram);this.ppu.oam.set(s.ppu.oam);this.ppu.palette.set(s.ppu.palette);
      this.apu.frameCounter=s.apu.frameCounter;this.apu.frameMode=s.apu.frameMode;Object.assign(this.apu.pulse1,s.apu.pulse1);Object.assign(this.apu.pulse2,s.apu.pulse2);Object.assign(this.apu.triangle,s.apu.triangle);Object.assign(this.apu.noise,s.apu.noise);Object.assign(this.apu.dmc,s.apu.dmc);
      this.bus.ram.set(s.bus.ram);
      if(s.mapper.type===4 && this.ppu.mapper instanceof Mapper4){this.ppu.mapper.bankData.set(s.mapper.bankData);this.ppu.mapper.irqLatch=s.mapper.irqLatch;this.ppu.mapper.irqCounter=s.mapper.irqCounter;this.ppu.mapper.irqEnable=s.mapper.irqEnable;this.ppu.mapper.updatePrgMapping();this.ppu.mapper.updateChrMapping();}
    }
  }

  // ===== Main UI =====
  const nes = new NES(document.getElementById('screen'));
  const btnRun=document.getElementById('btnRun'), btnPause=document.getElementById('btnPause'), btnReset=document.getElementById('btnReset'), romName=document.getElementById('romName');
  
  document.getElementById('rom').addEventListener('change',async e=>{
    const f=e.target.files[0]; if(!f)return; romName.textContent=f.name;
    try{ nes.loadROM(new Uint8Array(await f.arrayBuffer())); btnRun.disabled=false;btnPause.disabled=false;btnReset.disabled=false; }
    catch(err){alert('Load failed: '+err.message);}
  });
  btnRun.onclick=()=>nes.run(); btnPause.onclick=()=>nes.pause(); btnReset.onclick=()=>nes.reset();
  
  window.addEventListener('touchmove',e=>{e.preventDefault()},{passive:false});
  window.addEventListener('scroll',()=>window.scrollTo(0,0));
  document.body.addEventListener('wheel',e=>e.preventDefault(),{passive:false});

  // ===== Settings Logic =====
  let settingsOpen=false, pausedByMenu=false;
  const modal=document.getElementById('settingsModal'), btnSet=document.getElementById('btnSettings');
  const toggleSettings=()=>{
    settingsOpen=!settingsOpen;
    if(settingsOpen){ btnSet.classList.add('active'); modal.classList.add('active'); if(nes.running){nes.pause();pausedByMenu=true;} }
    else{ btnSet.classList.remove('active'); modal.classList.remove('active'); if(pausedByMenu){nes.run();pausedByMenu=false;} }
  };
  btnSet.addEventListener('click',toggleSettings); btnSet.addEventListener('touchstart',e=>{e.preventDefault();e.stopPropagation();toggleSettings();});
  window.closeSettings=()=>{if(settingsOpen)toggleSettings();};

  // Nav
  const navItems=document.querySelectorAll('.settings-nav-item'), pages=document.querySelectorAll('.settings-page'), settingsTitle=document.getElementById('settingsTitle');
  const pageTitles={audio:'Audio Settings',input:'Input Settings',display:'Display Settings',emulation:'Emulation Settings',cheats:'Cheats Manager',rom:'ROM Management',savestate:'Save States'};
  navItems.forEach(item=>{
    item.addEventListener('click',()=>{
      navItems.forEach(n=>n.classList.remove('active')); item.classList.add('active');
      pages.forEach(p=>p.classList.remove('active'));
      const pName=item.dataset.page; document.getElementById('page'+pName.charAt(0).toUpperCase()+pName.slice(1)).classList.add('active');
      settingsTitle.textContent=pageTitles[pName];
    });
  });

  // Audio
  document.getElementById('toggleAudioEnabled').onclick=e=>{Settings.audio.enabled=!Settings.audio.enabled;e.currentTarget.classList.toggle('active',Settings.audio.enabled);};
  document.getElementById('sliderVolume').oninput=e=>{const v=parseInt(e.target.value);Settings.audio.volume=v/100;document.getElementById('volumeDisplay').textContent=v+'%';};

  // Input
  document.getElementById('toggleKeyboard').onclick=e=>{Settings.input.keyboard=!Settings.input.keyboard;e.currentTarget.classList.toggle('active',Settings.input.keyboard);};
  document.getElementById('toggleTouch').onclick=e=>{Settings.input.touch=!Settings.input.touch;e.currentTarget.classList.toggle('active',Settings.input.touch); document.getElementById('mobileControls').style.display=Settings.input.touch?'flex':'none';};
  
  // Display
  document.getElementById('toggleIntegerScale').onclick=e=>{Settings.display.integerScale=!Settings.display.integerScale;e.currentTarget.classList.toggle('active',Settings.display.integerScale);};
  document.getElementById('toggleScanlines').onclick=e=>{Settings.display.scanlines=!Settings.display.scanlines;e.currentTarget.classList.toggle('active',Settings.display.scanlines);document.getElementById('scanlines').classList.toggle('active',Settings.display.scanlines);};

  // Emulation
  document.getElementById('sliderSpeed').oninput=e=>{const v=parseInt(e.target.value);Settings.emulation.speed=v/100;document.getElementById('speedDisplay').textContent=(v/100).toFixed(1)+'x';};
  document.getElementById('btnResetEmulator').onclick=e=>{if(nes.cpu){nes.reset();e.target.textContent='âœ“ Reset!';setTimeout(()=>e.target.textContent='Reset',1000);}};

  // Cheats
  const renderCheats=()=>{
    const list=document.getElementById('cheatListContainer'); list.innerHTML='';
    Settings.cheats.forEach((c,i)=>{
      const row=document.createElement('div'); row.className='cheat-item';
      row.innerHTML=`<span>Addr: $${toHex(c.addr,4)} &rarr; Val: $${toHex(c.val)}</span><span class="cheat-btn-del" data-idx="${i}">âœ•</span>`;
      list.appendChild(row);
    });
    document.querySelectorAll('.cheat-btn-del').forEach(b=>b.onclick=e=>{
      Settings.cheats.splice(parseInt(e.target.dataset.idx),1); renderCheats();
    });
  };
  document.getElementById('btnAddCheat').onclick=()=>{
    const addrStr=document.getElementById('cheatAddr').value, valStr=document.getElementById('cheatVal').value;
    const addr=parseInt(addrStr,16), val=parseInt(valStr,16);
    if(!isNaN(addr) && !isNaN(val) && addr>=0 && addr<=0xFFFF && val>=0 && val<=0xFF){
      Settings.cheats.push({addr,val}); renderCheats();
      document.getElementById('cheatAddr').value=''; document.getElementById('cheatVal').value='';
    }
  };

  // ROM URL
  const btnFetchROM=document.getElementById('btnFetchROM'), statusROM=document.getElementById('romUrlStatus');
  btnFetchROM.onclick=async()=>{
    const url=document.getElementById('inputROMUrl').value.trim();
    if(!url){statusROM.innerHTML='<div class="error-message">Enter URL</div>';return;}
    btnFetchROM.disabled=true; btnFetchROM.textContent='Fetching...'; statusROM.innerHTML='';
    try{
      const res=await fetch(url); if(!res.ok)throw new Error(res.status);
      const buf=new Uint8Array(await res.arrayBuffer());
      nes.loadROM(buf);
      romName.textContent=url.split('/').pop()||'rom.nes';
      btnRun.disabled=false; btnPause.disabled=false; btnReset.disabled=false;
      statusROM.innerHTML='<div class="success-message">âœ“ Loaded!</div>';
      setTimeout(()=>{closeSettings();nes.run();},1000);
    }catch(e){statusROM.innerHTML=`<div class="error-message">Error: ${e.message}</div>`;}
    finally{btnFetchROM.disabled=false; btnFetchROM.textContent='Fetch ROM';}
  };

  // Save States
  const btnExport=document.getElementById('btnExportState'), btnImport=document.getElementById('btnImportState'), inpState=document.getElementById('inputSaveState'), statusState=document.getElementById('saveStateStatus');
  const checkRom=()=>{const ok=!!nes.cpu; btnExport.disabled=!ok; btnImport.disabled=!ok;};
  const oldLoad=nes.loadROM.bind(nes); nes.loadROM=(...a)=>{oldLoad(...a);checkRom();}; checkRom();
  
  btnExport.onclick=()=>{
    try{
      const b=new Blob([JSON.stringify(nes.serializeState())],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=(romName.textContent||'state')+'.sav'; a.click();
      statusState.innerHTML='<div class="success-message">âœ“ Exported</div>'; setTimeout(()=>statusState.innerHTML='',2000);
    }catch(e){statusState.innerHTML=`<div class="error-message">${e.message}</div>`;}
  };
  btnImport.onclick=()=>inpState.click();
  inpState.onchange=async e=>{
    if(!e.target.files[0])return;
    if(nes.cpu && !confirm("Overwrite current progress?")) { inpState.value=''; return; }
    try{
      nes.deserializeState(JSON.parse(await e.target.files[0].text()));
      statusState.innerHTML='<div class="success-message">âœ“ Loaded</div>'; setTimeout(()=>statusState.innerHTML='',2000);
    }catch(e){statusState.innerHTML=`<div class="error-message">${e.message}</div>`;}
    inpState.value='';
  };

})();
</script>
</body>
</html>
